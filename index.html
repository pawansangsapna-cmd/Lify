<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instagram DM + Video Call</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
  body {
    margin:0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
    min-height: 100vh;
    display:flex;
    flex-direction:column;
  }

  /* --- PASSWORD SCREEN --- */
  #passwordScreen {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:#000000e0; display:flex; flex-direction:column;
    justify-content:center; align-items:center; z-index:9999; color:white;
  }
  #passwordScreen input {
    padding:15px; font-size:22px; width:150px; text-align:center;
    border-radius:10px; border:none; outline:none; margin-bottom:15px;
  }
  #passwordScreen button {
    padding:10px 20px; font-size:18px; border:none; border-radius:10px;
    background:#0095f6; color:white; cursor:pointer;
  }
  #passError { color:red; margin-top:15px; font-size:18px; }

  .room-info {
    padding:10px;
    background: rgba(255,255,255,0.9);
    border-bottom:1px solid #dbdbdb;
  }
  .link-box { display:flex; gap:10px; margin-top:5px; }
  .link-box input { flex:1; padding:5px; font-size:14px; border-radius:5px; }
  .link-box button { padding:5px 10px; font-size:14px; background:#0095f6; color:#fff; border:none; cursor:pointer; border-radius:5px; }

  .messages {
    flex:1;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .message { max-width:70%; padding:10px; border-radius:15px; word-break: break-word; }
  .sent { align-self:flex-end; background:#dcf8c6; }
  .received { align-self:flex-start; background:#fff; border:1px solid #dbdbdb; }

  .input-box {
    display:flex;
    border-top:1px solid #dbdbdb;
    background: rgba(255,255,255,0.95);
    padding:5px;
    gap:5px;
  }
  .input-box input[type="text"] { flex:1; padding:10px; border:none; outline:none; font-size:16px; border-radius:10px; }
  .input-box input[type="file"] { border:none; }
  .input-box button { padding:10px 15px; border:none; background:#0095f6; color:#fff; cursor:pointer; font-weight:bold; border-radius:10px; }

  .video-container { display:flex; justify-content:space-around; margin:10px 0; flex-wrap:wrap; gap:10px; }
  video { width:48%; max-height:300px; border:1px solid #dbdbdb; border-radius:10px; background:#000; }

  .controls { display:flex; gap:10px; margin:10px; justify-content:center; flex-wrap:wrap; }
  .controls button { padding:8px 12px; border:none; border-radius:10px; background:#0095f6; color:#fff; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px; }

  img, video.received-file { max-width:200px; border-radius:10px; margin-top:5px; }

  @media(max-width:768px){
    .video-container video { width:100%; max-height:200px; }
  }
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="passwordScreen">
  <h2 style="margin-bottom:20px; font-size:26px;">Enter 4‚ÄëDigit Password</h2>
  <input id="passInput" maxlength="4" placeholder="****" />
  <button onclick="checkPass()">Unlock</button>
  <p id="passError"></p>
</div>

<div class="room-info">
  <div>Your Room Link (Share with friend):</div>
  <div class="link-box">
    <input type="text" id="roomLink" readonly>
    <button onclick="copyLink()">Copy</button>
  </div>
</div>

<div class="messages" id="messages"></div>

<div class="input-box">
  <input type="text" id="messageInput" placeholder="Message...">
  <input type="file" id="fileInput" accept="image/*,video/*">
  <button onclick="sendMessage()">Send</button>
</div>

<div class="video-container">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<div class="controls">
  <button id="switchBtn">üîÑ Switch</button>
  <button id="muteBtn">üé§ Mute</button>
  <button id="speakerBtn">üîä Speaker</button>
  <button id="endCallBtn">‚ùå End</button>
</div>

<script>
// ------------------ PASSWORD CHECK ------------------
function checkPass() {
  const input = document.getElementById("passInput").value;
  if(input === "1008"){
    document.getElementById("passwordScreen").style.display="none";
    initCall(); // Start the main app
  } else {
    document.getElementById("passError").innerText="‚ùå Wrong Password!";
  }
}

// ------------------ MESSAGES ------------------
let messagesDiv = document.getElementById('messages');
let peer, localStream, currentCall, conn;
let videoFacingMode = "user"; 
let muted=false, speakerOn=true;

function appendMessage(cls, text='', fileData='', fileType=''){
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', cls);
  if(fileData){
    if(fileType.startsWith('image')){
      const img = document.createElement('img');
      img.src = fileData;
      msgDiv.appendChild(img);
    } else if(fileType.startsWith('video')){
      const vid = document.createElement('video');
      vid.src = fileData;
      vid.controls = true;
      vid.classList.add('received-file');
      msgDiv.appendChild(vid);
    }
  }
  if(text) msgDiv.appendChild(document.createTextNode(text));
  messagesDiv.appendChild(msgDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage(){
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  const fileInput = document.getElementById('fileInput');

  if(text){
    appendMessage('sent', text);
    if(conn && conn.open) conn.send({type:'text', content:text});
    input.value='';
  }

  if(fileInput.files.length>0){
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{
      appendMessage('sent','',reader.result,file.type);
      if(conn && conn.open) conn.send({type:'file', content:reader.result, fileType:file.type});
    };
    reader.readAsDataURL(file);
    fileInput.value='';
  }
}

function copyLink(){
  const input = document.getElementById('roomLink');
  input.select();
  input.setSelectionRange(0,99999);
  document.execCommand('copy');
  alert('Room link copied!');
}

// ------------------ VIDEO ------------------
async function startStream(){
  localStream = await navigator.mediaDevices.getUserMedia({
    video: { width:1280, height:720, frameRate:30, facingMode: videoFacingMode },
    audio:true
  });
  document.getElementById('localVideo').srcObject = localStream;
}

async function switchCamera(){
  if(!localStream) return;
  videoFacingMode = (videoFacingMode === 'user') ? 'environment' : 'user';
  const tracks = localStream.getTracks();
  tracks.forEach(track => track.stop());
  await startStream();
  if(currentCall){
    const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
    sender.replaceTrack(localStream.getVideoTracks()[0]);
  }
}

// ------------------ PEERJS ------------------
async function initCall(){
  await startStream();
  const userId = 'peer-'+Math.random().toString(36).substring(2,8);
  const link = window.location.origin + window.location.pathname + '?peer=' + userId;
  document.getElementById('roomLink').value = link;

  peer = new Peer(userId,{
    host:'0.peerjs.com',
    port:443,
    secure:true
  });

  peer.on('open', id=>{
    const urlParams = new URLSearchParams(window.location.search);
    const otherId = urlParams.get('peer');
    if(otherId && otherId!==id){
      currentCall = peer.call(otherId, localStream);
      currentCall.on('stream', remoteStream=>{
        document.getElementById('remoteVideo').srcObject = remoteStream;
      });
      conn = peer.connect(otherId);
      setupDataConnection();
    }
  });

  peer.on('call', call=>{
    currentCall = call;
    call.answer(localStream);
    call.on('stream', remoteStream=>{
      document.getElementById('remoteVideo').srcObject = remoteStream;
    });
  });

  peer.on('connection', c=>{
    conn = c;
    setupDataConnection();
  });

  peer.on('error', err=>{ console.error(err); alert('PeerJS Error:'+err); });
}

function setupDataConnection(){
  if(!conn) return;
  conn.on('data', data=>{
    if(data.type==='text'){
      appendMessage('received', data.content);
    } else if(data.type==='file'){
      appendMessage('received','',data.content,data.fileType);
    }
  });
}

// ------------------ CONTROLS ------------------
document.getElementById('muteBtn').onclick = ()=>{
  if(!localStream) return;
  muted = !muted;
  localStream.getAudioTracks()[0].enabled = !muted;
  document.getElementById('muteBtn').innerText = muted ? 'üé§ Unmute' : 'üé§ Mute';
};
document.getElementById('speakerBtn').onclick = ()=>{
  const remoteVideo = document.getElementById('remoteVideo');
  speakerOn = !speakerOn;
  remoteVideo.muted = !speakerOn;
  document.getElementById('speakerBtn').innerText = speakerOn ? 'üîä Speaker' : 'üîä Off';
};
document.getElementById('endCallBtn').onclick = ()=>{
  if(currentCall) currentCall.close();
  if(peer) peer.destroy();
  alert('Call ended');
};
document.getElementById('switchBtn').onclick = switchCamera;

</script>
</body>
</html>
